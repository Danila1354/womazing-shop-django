{% extends "base.html" %}

{% block title %}{{ product.name }}{% endblock %}
{% load static%}
{% load thumbnail %}
{% block content %}

<section class="section page-hero">
    <div class="container">
        <h1 class="section-title page-hero__title">{{ product.name }}</h1>

        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'pages:home' %}">Главная</a></li>
                <li class="breadcrumb-item"><a href="{% url 'catalog:catalog' %}">Магазин</a></li>
                <li class="breadcrumb-item active">{{ product.name }}</li>
            </ol>
        </nav>
    </div>
</section>

<form method="post">
    {% csrf_token %}

    {{ form.size.as_hidden }}
    {{ form.color.as_hidden }}

<section class="section product-card">
    <div class="container">
        <div class="row">

            <div class="col-6 product-card__image-container">
                {% if variant.image %}
                    {% thumbnail variant.image "1000x1500" as im %}
                    <img id="product-image" src="{{ im.url }}" 
                        alt="{{ product.name }}"
                        class="product-card__image">
                    {% endthumbnail %}
                {% else %}
                    <img src="{% static 'img/placeholder.png' %}" 
                        alt="{{ product.name }}" 
                        class="product-card__image">
                {% endif %}
            </div>
            <div class="col-6 product-card__info">
                <p class="shop-item__price product-card__price" id="product-price">
                    {% if variant.price_with_discount %}
                        <span class="sale_price">${{ variant.price_with_discount }}</span>
                        <span class="standard_price small_standard_price">${{ variant.price }}</span>
                    {% else %}
                        <span class="standard_price">${{ variant.price }}</span>
                    {% endif %}
                </p>

                <div class="product-card__sizes-block">
                    <p class="product-card__choose-price">Выберите размер</p>
                    <div class="product-card__sizes">
                        {% for size in form.fields.size.queryset %}
                        <button type="button"
                                class="btn product-card__size-button {% if size.id == form.initial.size.id %}active{% endif %}"
                                data-size="{{ size.id }}">
                            {{ size.name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>

                <div class="product-card__colors-block">
                    <p class="product-card__choose-color">Выберите цвет</p>
                    <div class="product-card__colors">
                    {% for color in form.fields.color.queryset %}
                    <button type="button"
                            class="btn product-card__color-button {% if color.id == form.initial.color.id %}active{% endif %}"
                            data-color="{{ color.id }}"
                            style="background-color: {{ color.value }}">
                    </button>
                    {% endfor %}
                    </div>
                </div>
                

                <div class="product-card__add-to-cart">

                    <div class="product-card__quantity-wrapper">
                        <button type="button" class="product-card__quantity-btn minus">−</button>

                        <input type="number"
                               name="quantity"
                               class="product-card__quantity-input"
                               value="1"
                               min="1">

                        <button type="button" class="product-card__quantity-btn plus">+</button>
                    </div>

                    <button type="submit" class="btn shop-button">
                        Добавить в корзину
                    </button>

                </div>
            </div>
        </div>
    </div>
</section>
</form>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {

    document.querySelectorAll('.product-card__size-button').forEach(btn => {
        btn.addEventListener('click', () => {
            document.getElementById('id_size').value = btn.dataset.size;
            document.querySelectorAll('.product-card__size-button')
                .forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        });
    });

    document.querySelectorAll('.product-card__color-button').forEach(btn => {
        btn.addEventListener('click', () => {
            document.getElementById('id_color').value = btn.dataset.color;
            document.querySelectorAll('.product-card__color-button')
                .forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        });
    });
    const quantityInput = document.querySelector('.product-card__quantity-input');
    document.querySelector('.plus').onclick = () => {
        let val = parseInt(quantityInput.value);
        if (isNaN(val) || val < 1) val = 1;
        quantityInput.value = val + 1;
    };

    document.querySelector('.minus').onclick = () => {
        let val = parseInt(quantityInput.value);
        if (isNaN(val) || val < 1) val = 1;
        quantityInput.value = val - 1;
        if (quantityInput.value < 1) quantityInput.value = 1;
    };
});

</script>
{{ available_size_color_combinations|json_script:"size-color-map" }};
<script>
document.addEventListener('DOMContentLoaded', () => {
    const sizeColorMap = JSON.parse(
        document.getElementById('size-color-map').textContent
    );

    const sizeButtons = document.querySelectorAll('.product-card__size-button');
    const colorButtons = document.querySelectorAll('.product-card__color-button');

    function updateColorsForSize(selectedSizeId) {
        const allowedColors = sizeColorMap[selectedSizeId] || [];

        colorButtons.forEach(colorBtn => {
            const colorId = parseInt(colorBtn.dataset.color);
            if (allowedColors.includes(colorId)) {
                colorBtn.classList.remove('disabled-color');
            } else {
                colorBtn.classList.add('disabled-color');
                colorBtn.classList.remove('active');
            }
        });
    }

    sizeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const selectedSizeId = btn.dataset.size;
            sizeButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            document.getElementById('id_size').value = selectedSizeId;

            updateColorsForSize(selectedSizeId);
        });
    });

    colorButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            if (btn.classList.contains('disabled-color')) return;

            colorButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('id_color').value = btn.dataset.color;
        });
    });

    const activeSizeBtn = document.querySelector('.product-card__size-button.active');
    if (activeSizeBtn) {
        const selectedSizeId = activeSizeBtn.dataset.size;
        document.getElementById('id_size').value = selectedSizeId;
        updateColorsForSize(selectedSizeId);

        const activeColorBtn = document.querySelector('.product-card__color-button.active');
        if (activeColorBtn && activeColorBtn.classList.contains('disabled-color')) {
            activeColorBtn.classList.remove('active');
        }
    }

    const activeColorBtn = document.querySelector('.product-card__color-button.active');
    if (activeColorBtn) {
        document.getElementById('id_color').value = activeColorBtn.dataset.color;
    }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {

    const productId = {{ product.id }};
    const imageEl = document.getElementById('product-image');
    const priceEl = document.getElementById('product-price');

    const sizeColorMap = JSON.parse(
        document.getElementById('size-color-map').textContent
    );

    const sizeButtons = document.querySelectorAll('.product-card__size-button');
    const colorButtons = document.querySelectorAll('.product-card__color-button');

    function updateColorsForSize(selectedSizeId) {
        const allowedColors = sizeColorMap[selectedSizeId] || [];

        colorButtons.forEach(colorBtn => {
            const colorId = parseInt(colorBtn.dataset.color);
            if (allowedColors.includes(colorId)) {
                colorBtn.classList.remove('disabled-color');
            } else {
                colorBtn.classList.add('disabled-color');
                colorBtn.classList.remove('active');
            }
        });

        const firstAvailableColor = allowedColors[0];
        if (firstAvailableColor) {
            document.getElementById('id_color').value = firstAvailableColor;
            colorButtons.forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`.product-card__color-button[data-color='${firstAvailableColor}']`);
            if (btn) btn.classList.add('active');
            return firstAvailableColor;
        }
        return null;
    }

    function loadVariant() {
        const size = document.getElementById('id_size').value;
        const color = document.getElementById('id_color').value;

        if (!size || !color) return;

        fetch(`{% url 'catalog:get_variant' product.id %}?size=${size}&color=${color}`)
            .then(response => {
                if (!response.ok) throw new Error("Variant not found");
                return response.json();
            })
            .then(data => {
                if (data.image && imageEl) {
                    imageEl.src = data.image;
                }

                if (data.price_with_discount) {
                    priceEl.innerHTML = `
                        <span class="sale_price">$${data.price_with_discount}</span>
                        <span class="standard_price small_standard_price">$${data.price}</span>
                    `;
                } else {
                    priceEl.innerHTML = `
                        <span class="standard_price">$${data.price}</span>
                    `;
                }
            })
            .catch(err => console.warn(err));
    }

    sizeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            sizeButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const selectedSizeId = btn.dataset.size;
            document.getElementById('id_size').value = selectedSizeId;

            const firstColor = updateColorsForSize(selectedSizeId);
            if (firstColor) loadVariant();
        });
    });

    colorButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            if (btn.classList.contains('disabled-color')) return;

            colorButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('id_color').value = btn.dataset.color;

            loadVariant();
        });
    });

    const activeSizeBtn = document.querySelector('.product-card__size-button.active');
    if (activeSizeBtn) {
        const selectedSizeId = activeSizeBtn.dataset.size;
        document.getElementById('id_size').value = selectedSizeId;
        updateColorsForSize(selectedSizeId);
        loadVariant();
    }

});
</script>
{% endblock %}